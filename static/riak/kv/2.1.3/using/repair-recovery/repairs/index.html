<!DOCTYPE html>

<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"></html><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"></html><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"></html><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->




<head class="tutorials">
  <meta charset="utf-8">
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width">
  <meta name="project" content="riak_kv">
  <meta name="version" content="2.1.3">
  <meta name="base-url" content="">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

  <title>Repairs</title>

  <link href="/css/all.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/print.css" media="print" rel="stylesheet" type="text/css">

  
  <style type="text/css"> .js_enabled pre { visibility : hidden; } </style>
  <script type="text/javascript">
    document.documentElement.className = 'js_enabled';
  </script>
</head>



<body class="riak_kv 2.1.3 latest ">

  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-T9C8MK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-T9C8MK');</script>

  
<aside id="nav-container" role="complementary">
  <nav class="overview" id="primary-nav" role="nav">
    <div id="primary-nav-content">
      <h2 class="responsive-link"><a class="responsive-toggle"></a></h2>

      
      <form id="searchbox_011972015458788978446:zgdcy4fa-o0" action="">
        <div class="nav-field-container">
          <div id="icon-container-search">
            <div class="icon-container"><span aria-hidden="true" class="nav-icon-search icon-search"></span></div>
            <span class="separator">&#124;</span>
          </div>
          <input id="main-search" name="q" placeholder="Search" size="5" type="search" />
        </div>
      </form>

      <div class="clear"></div>

      
      <h3 class="responsive-link visit-basho">
        <a href="http://www.basho.com">
          <div class="icon-container">
            <span aria-hidden="true" class="nav-icon" data-icon="&#xe003;"></span>
          </div>
          <span class="separator">&#124;</span>
          <span class="menu-title">Visit Basho</span>
          <div class="clear"></div>
        </a>
      </h3>

      
      <h3 class="responsive-link">
        <a href="/index.html">
          <div class="icon-container">
            <span aria-hidden="true" class="nav-icon" data-icon="&#xe003;"></span>
          </div>
          <span class="separator">&#124;</span>
          <span class="menu-title">All Riak Projects</span>
          <div class="clear"></div>
        </a>
      </h3>

      
      
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-riak"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/riak/kv/2.1.3/">Riak KV</a></span>
        <div class="clear"></div>
      </h3>
      
       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-download-alt"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/riak/kv/2.1.3/downloads/">Download Riak KV</a></span>
        <div class="clear"></div>
      </h3>
      
       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-install"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/riak/kv/2.1.3/setup/">Setup</a></span>
        <div class="clear"></div>
      </h3>
      
      
        
<ul class="depth-1">
  
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/setup/planning/">Planning</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/start/">Start Planning</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/operating-system/">OS Support</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/setup/planning/backend/">Choosing a Backend</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/backend/bitcask/">Bitcask</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/backend/leveldb/">LevelDB</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/backend/memory/">Memory</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/backend/multi/">Multi-backend</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/cluster-capacity/">Cluster Capacity</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/bitcask-capacity-calc/">Bitcask Capacity Calculator</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/best-practices/">Best Practices</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/planning/future/">Planning for the Future</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/setup/installing/">Installing</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/amazon-web-services/">Amazon Web Services</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/debian-ubuntu/">Debian &amp; Ubuntu</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/freebsd/">FreeBSD</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/mac-osx/">Mac OS X</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/rhel-centos/">RHEL &amp; CentOS</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/smartos/">SmartOS</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/solaris/">Solaris</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/suse/">SUSE</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/windows-azure/">Windows Azure</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/setup/installing/source/">Installing From Source</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/source/erlang/">Installing Erlang</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/source/jvm/">Installing the JVM</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/installing/verify/">Verifying an Installation</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/setup/upgrading/">Upgrading</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/setup/upgrading/checklist/">Production Checklist</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/upgrading/version/">Upgrading by Version</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/upgrading/cluster/">Upgrading a Cluster</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/upgrading/multi-datacenter/">Upgrading Multi-Datacenter</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/setup/upgrading/downgrade/">Downgrading</a>
  
  </li></ul>

  
  </li></ul>

       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-cog"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/riak/kv/2.1.3/configuring/">Configuring</a></span>
        <div class="clear"></div>
      </h3>
      
      
        
<ul class="depth-1">
  
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/basic/">Basic Configuration</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/backend/">Backend Configuration</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/managing/">Managing Configuration</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/reference/">Configuration Reference</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/strong-consistency/">Implementing Strong Consistency</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/load-balancing-proxy/">Load Balancing &amp; Proxy</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/mapreduce/">MapReduce Settings</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/search/">Search Settings</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/configuring/v3-multi-datacenter/">V3 Multi-Datacenter</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/v3-multi-datacenter/quick-start/">Quickstart</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/v3-multi-datacenter/nat/">With NAT</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/v3-multi-datacenter/ssl/">SSL</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/configuring/v2-multi-datacenter/">V2 Multi-Datacenter</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/v2-multi-datacenter/quick-start/">Quickstart</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/v2-multi-datacenter/nat/">With NAT</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/configuring/v2-multi-datacenter/ssl/">SSL</a>
  
  </li></ul>

  
  </li></ul>

       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-database"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/riak/kv/2.1.3/using/">Using</a></span>
        <div class="clear"></div>
      </h3>
      
      
        
<ul class="depth-1">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/running-a-cluster/">Running a Cluster</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/admin/">Cluster Administration</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/admin/commands/">Cluster Admin Commands</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/admin/riak-admin/">riak-admin CLI</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/admin/riak-cli/">riak CLI</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/admin/riak-control/">Riak Control</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/cluster-operations/">Cluster Operations</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/adding-removing-nodes/">Adding/Removing Nodes</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/changing-cluster-info/">Changing Cluster Information</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/replacing-node/">Replacing a Node</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/inspecting-node/">Inspecting a Node</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/bucket-types/">Bucket Types</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/logging/">Logging</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/backing-up/">Backing Up</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/handoff/">Handoff</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/object-deletion/">Object Deletion</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/secondary-indexes/">Secondary Indexes</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/monitoring-strong-consistency/">Monitoring Strong Consistency</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/load-balancing/">Load Balancing</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/backend/">Backend</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/v3-multi-datacenter/">V3 Multi-Datacenter</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/cluster-operations/v2-multi-datacenter/">V2 Multi-Datacenter</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/repair-recovery/">Repair &amp; Recovery</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/repair-recovery/failure-recovery/">Failure &amp; Recovery</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/repair-recovery/errors/">Errors</a>
  
  </li>
  <li class="current">
  
    <a href="/riak/kv/2.1.3/using/repair-recovery/repairs/">Repairs</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/repair-recovery/rolling-restart/">Rolling Restarts</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/security/">Security</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/security/basics/">Security Basics</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/security/managing-sources/">Managing Security Sources</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/security/best-practices/">Best Practices</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/security/v2-v3-ssl-ca/">V2/V3 SSL &amp; CA Validation</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/performance/">Performance</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/performance/benchmarking/">Benchmarking</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/performance/open-files-limit/">Open Files Limit</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/performance/v2-scheduling-fullsync/">V2 Scheduling Fullsync</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/performance/multi-datacenter-tuning/">Multi-Datacenter Replication</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/troubleshooting/">Troubleshooting</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/troubleshooting/product-advisories/">Product Advisories</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/troubleshooting/product-advisories/210-dataloss/">Default Configuration For Handoff May Cause Data Loss</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/troubleshooting/product-advisories/appconfig-foward/">Forward Incompatibility of app.config</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/troubleshooting/product-advisories/dvv-lastwritewins/">Incompatibility between Dotted Version Vectors and Last Write Wins</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/troubleshooting/product-advisories/maps-204/">Map Data Type Disk Incompatibility</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/troubleshooting/product-advisories/ssl-poodle/">SSL 3.0 Vulnerability and POODLE Attack</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/troubleshooting/http-204/">HTTP 204</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/using/reference/">Reference</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/logging/">Logging</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/handoff/">Handoff</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/bucket-types/">Bucket Types</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/object-deletion/">Object Deletion</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/runtime-interaction/">Runtime Interaction</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/failure-recovery/">Failure &amp; Recovery</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/monitoring/">Monitoring</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/search-secondary-indexes/">Search &amp; Secondary Indexes</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/strong-consistency/">Strong Consistency</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/multi-datacenter/">Multi-Datacenter</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/v3/">V3 Replication</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/v2/">V2 Replication</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/using/reference/architecture/">Architecture</a>
  
  </li></ul>

  
  </li></ul>

       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-lambda"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/riak/kv/2.1.3/developing/">Developing</a></span>
        <div class="clear"></div>
      </h3>
      
      
        
<ul class="depth-1">
  
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/">Getting Started</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/java/">Java</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/java/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/java/querying/">Querying</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/java/object-modeling/">Object Modeling</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/ruby/">Ruby</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/ruby/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/ruby/querying/">Querying</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/ruby/object-modeling/">Object Modeling</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/python/">Python</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/python/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/python/querying/">Querying</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/python/object-modeling/">Object Modeling</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/csharp/">C Sharp</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/csharp/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/csharp/querying/">Querying</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/csharp/object-modeling/">Object Modeling</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/nodejs/">NodeJS</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/nodejs/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/nodejs/querying/">Querying</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/nodejs/object-modeling/">Object Modeling</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/erlang/">Erlang</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/erlang/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/erlang/querying/">Querying</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/erlang/object-modeling/">Object Modeling</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/golang/">Go</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/golang/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/golang/querying/">Querying</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/golang/object-modeling/">Object Modeling</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/getting-started/php/">PHP</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/php/crud-operations/">CRUD Operations</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/getting-started/php/querying/">Querying</a>
  
  </li></ul>

  
  </li></ul>

  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/usage/">Usage</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/creating-objects/">Creating Objects</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/reading-objects/">Reading Objects</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/updating-objects/">Updating Objects</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/deleting-objects/">Deleting Objects</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/content-types/">Content Types</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/search/">Searching</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/mapreduce/">Using MapReduce</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/secondary-indexes/">Using Secondary Indexes</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/bucket-types/">Bucket Types</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/commit-hooks/">Using Commit Hooks</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/search-schemas/">Creating Search Schemas</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/searching-data-types/">Searching with Data Types</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/document-store/">Implementing a Document Store</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/custom-extractors/">Custom Extractors</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/usage/security/">Security</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/security/java/">Java</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/security/ruby/">Ruby</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/security/python/">Python</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/security/erlang/">Erlang</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/security/php/">PHP</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/replication/">Replication</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/">Conflict Resolution</a></span></h4>
    
<ul class="depth-3">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/java/">Java</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/ruby/">Ruby</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/python/">Python</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/csharp/">C Sharp</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/nodejs/">NodeJS</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/php/">PHP</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/usage/conflict-resolution/golang/">Go</a>
  
  </li></ul>

  
  </li></ul>

  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/data-types/">Data Types</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/data-modeling/">Data Modeling</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/app-guide/">Application Guide</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/app-guide/replication-properties/">Replication Properties</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/app-guide/strong-consistency/">Strong Consistency</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/app-guide/write-once/">Write Once</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/app-guide/reference/">Reference</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/client-libraries/">Client Libraries</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/developing/api/">APIs</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/developing/api/repl-hooks/">V2 Multi-Datacenter REPL Hooks API</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/api/backend/">Backend API</a>
  
  </li></ul>

  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/developing/faq/">Developing FAQ</a>
  
  </li></ul>

       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-beaker"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/riak/kv/2.1.3/learn/">Learning</a></span>
        <div class="clear"></div>
      </h3>
      
      
        
<ul class="depth-1">
  
  <li >
  
    <a href="/riak/kv/2.1.3/learn/why-riak-kv/">Why Riak KV?</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/use-cases/">Use Cases</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/new-to-nosql/">New to NoSQL?</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/glossary/">Riak KV Glossary</a>
  
  </li>
  <li >
  
    <h4><span><a href="/riak/kv/2.1.3/learn/concepts/">Concepts</a></span></h4>
    
<ul class="depth-2">
  
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/active-anti-entropy/">Active Anti-Entropy</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/buckets/">Buckets</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/capability-negotiation/">Capability Negotiation</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/causal-context/">Causal Context</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/clusters/">Clusters</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/crdts/">Data Types</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/eventual-consistency/">Eventual Consistency</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/keys-and-objects/">Keys and Objects</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/replication/">Replication</a>
  
  </li>
  <li >
  
    <a href="/riak/kv/2.1.3/learn/concepts/vnodes/">Vnodes</a>
  
  </li></ul>

  
  </li></ul>

       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-comments"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/community">Community</a></span>
        <div class="clear"></div>
      </h3>
      <ul></ul> 
    </div>
  </nav>

  
  <ul id="fixed-nav">
    <li>
      <a href="https://github.com/basho/basho_docs" target="_blank">
        <div class="icon-container">
          <span aria-hidden="true" class="nav-icon" data-icon="&#xe004;"></span>
        </div>
        <span class="separator">&#124;</span>Available on GitHub
      </a>
    </li>
    <li>
      <a href="/riak/latest/community/">
        <div class="icon-container">
          <span aria-hidden="true" class="nav-icon" data-icon="&#xf059;"></span>
        </div>
        <span class="separator">&#124;</span>Get Help
      </a>
    </li>
  </ul>
</aside>


  <script>
  (function() {
    var cx = '011972015458788978446:zgdcy4fa-o0';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div style="width:0px;overflow:hidden;height:0px;">
  <gcse:search></gcse:search>
</div>


  <div role="main">

    <header class="masthead">
  <div id="header">
    
    <div id="header-inner">
      <div class="icon-reorder" id="nav-toggle"></div>

      <div id="top-nav">
        
        <a href="/riak/kv/2.1.3/downloads/"><span class="icon-download-alt"></span>Downloads</a>
        <div id="nav-more"><span class="icon-more"></span></div>
      </div>

      <a class="responsive-toggle"></a>
      
      
      <a class="logo" href="/index.html"><h1>Riak Docs</h1></a>
      
      <span class="tagline">Product tutorials, how-tos, and fully-documented APIs.</span>
      <div id="nav-menu">
        <h2>Links</h2>
        <ul>
          <li><a href="http://docs.basho.com/">Docs Home</a></li>
          <li><a href="http://basho.com/">Basho Website</a></li>
        </ul>
        
        <div id="nav-menu-arrow"></div>
        <div id="nav-menu-arrow-back"></div>
      </div>

      <div class="clear"></div>

      <div class="header-rule"></div>
    </div>
  </div>
</header>


    <article class="mainarticle">

      <div class="versions">
  <div id="version-ddown-button" class="unselected">
    <div class="version-ddown-title">Version</div>
    <div class="version-ddown-number">2.1.3</div>
    <div class="version-ddown-arrow"></div>
  </div>
  <ol id="version-list" style="display: none;">
  
  
    
    
      
      
      <li class="sans versions-0 current">DEV</li>
      
      <li class="current versions-0"><a class="versioned" href="/riak/kv/2.1.3/using/repair-recovery/repairs/">2.1.3</a></li>
    
    
      
      
      
      <li class=" versions-0 first"><a class="versioned" href="/riak/kv/2.1.1/using/repair-recovery/repairs/">2.1.1</a></li>
    
  
    
    
      
      
      
      <li class="sans versions-1 current">LTS</li>
      <li class=" versions-1"><a class="versioned" href="/riak/kv/2.0.6/using/repair-recovery/repairs/">2.0.6</a></li>
    
      
      
      
      
      <li class=" versions-1"><a class="versioned" href="/riak/kv/2.0.5/using/repair-recovery/repairs/">2.0.5</a></li>
    
      
      
      
      
      <li class=" versions-1"><a class="versioned" href="/riak/kv/2.0.4/using/repair-recovery/repairs/">2.0.4</a></li>
    
      
      
      
      
      <li class=" versions-1"><a class="versioned" href="/riak/kv/2.0.2/using/repair-recovery/repairs/">2.0.2</a></li>
    
      
      
      
      
      <li class=" versions-1"><a class="versioned" href="/riak/kv/2.0.1/using/repair-recovery/repairs/">2.0.1</a></li>
    
    
      
      
      
      <li class=" versions-1 first"><a class="versioned" href="/riak/kv/2.0.0/using/repair-recovery/repairs/">2.0.0</a></li>
    
  
  
  <li class="versions-5 first"><a class="sans versioned" href="http://docs.basho.com/riak/1.4.12/">older</a></li>
  </ol>
</div>


      
      

      <header><h1>Repairs</h1></header>

      

      
      <nav id="toc">
        <h2 class="title">Contents</h2>
        <div id="toc-wrapper">
          <ol id="toc-items"></ol>
        </div>
      </nav>
      

      

<h2 id="repairing-secondary-indexes:2251b6d571e7a2a3be2d5d3e1ae405b3">Repairing Secondary Indexes</h2>

<p>The <code>riak-admin repair-2i</code> command can be used to repair any stale or missing secondary indexes.  This command scans and repairs any mismatches between the secondary index data used for querying and the secondary index data stored in the Riak objects. It can be run on all partitions of a node or on a subset of them.  We recommend scheduling these repairs outside of peak load time.</p>

<h3 id="running-a-repair:2251b6d571e7a2a3be2d5d3e1ae405b3">Running a Repair</h3>

<p>The secondary indexes of a single partition can be repaired by executing:</p>

<pre><code class="language-bash">riak-admin repair-2i &lt;Partition_ID&gt;
</code></pre>

<p>The secondary indexes of every partition can be repaired by executing the same command, without a partition ID:</p>

<pre><code class="language-bash">riak-admin repair-2i
</code></pre>

<h3 id="monitoring-a-repair:2251b6d571e7a2a3be2d5d3e1ae405b3">Monitoring a Repair</h3>

<p>Repairs can be monitored using the below command:</p>

<pre><code class="language-bash">riak-admin repair-2i status
</code></pre>

<h3 id="killing-a-repair:2251b6d571e7a2a3be2d5d3e1ae405b3">Killing a Repair</h3>

<p>In the event the secondary index repair operation needs to be halted, all repairs can be killed with:</p>

<pre><code class="language-bash">riak-admin repair-2i kill
</code></pre>

<h2 id="repairing-search-indexes:2251b6d571e7a2a3be2d5d3e1ae405b3">Repairing Search Indexes</h2>

<p>Riak Search indexes currently have no form of anti-entropy (such as read-repair). Furthermore, for performance and load balancing reasons, Search reads from one random node. This means that when a replica loss has occurred, inconsistent results may be returned.</p>

<h3 id="running-a-repair-1:2251b6d571e7a2a3be2d5d3e1ae405b3">Running a Repair</h3>

<p>If a replica loss has occurred, you need to run the repair command. This command repairs objects from a node&rsquo;s adjacent partitions on the ring, consequently fixing the search index.</p>

<p>This is done as efficiently as possible by generating a hash range for all the buckets and thus avoiding a preflist calculation for each key. Only a hash of each key is done, its range determined from a bucket&rarr;range map, and then the hash is checked against the range.</p>

<p>This code will force all keys in each partition on a node to be reread, thus rebuilding the search index properly.</p>

<ol>
<li><p>From a cluster node with Riak installed, attach to the Riak console:</p>

<pre><code class="language-bash">riak attach
</code></pre>

<p>You may have to hit enter again to get a console prompt.</p></li>

<li><p>Get a list of partitions owned by the node that needs repair:</p>

<pre><code class="language-erlang">{ok, Ring} = riak_core_ring_manager:get_my_ring().
</code></pre>

<p>You will get a lot of output with Ring record information. You can safely ignore it.</p></li>

<li><p>Then run the following code to get a list of partitions. Replace &lsquo;dev1@127.0.0.1&rsquo; with the name of the node you need to repair.</p>

<pre><code class="language-erlang">Partitions = [P || {P, 'dev1@127.0.0.1'} &lt;- riak_core_ring:all_owners(Ring)].
</code></pre>

<p>_Note: The above is an <a href="http://www.erlang.org/doc/programming_examples/list_comprehensions.html">Erlang list comprehension</a>, that loops over each <code>{Partition, Node}</code> tuple in the Ring, and extracts only the partitions that match the given node name, as a list._</p></li>

<li><p>Execute repair on all the partitions. Executing them all at once like this will cause a lot of <code>{shutdown,max_concurrency}</code> spam but it&rsquo;s not anything to worry about. That is just the transfers mechanism enforcing an upper limit on the number of concurrent transactions.</p>

<pre><code class="language-erlang">[riak_search_vnode:repair(P) || P &lt;- Partitions].
</code></pre></li>

<li><p>When you&rsquo;re done, press <code>Ctrl-D</code> to disconnect the console. DO NOT RUN q() which will cause the running Riak node to quit. Note that <code>Ctrl-D</code> merely disconnects the console from the service, it does not stop the code from running.</p></li>
</ol>

<h3 id="monitoring-a-repair-1:2251b6d571e7a2a3be2d5d3e1ae405b3">Monitoring a Repair</h3>

<p>The above Repair command can be slow, so if you reattach to the console, you can run the repair_status function. You can use the <code>Partitions</code> variable defined above to get the status of every partition.</p>

<pre><code class="language-erlang">[{P, riak_search_vnode:repair_status(P)} || P &lt;- Partitions].
</code></pre>

<p>When you&rsquo;re done, press <code>Ctrl-D</code> to disconnect the console.</p>

<h3 id="killing-a-repair-1:2251b6d571e7a2a3be2d5d3e1ae405b3">Killing a Repair</h3>

<p>Currently there is no easy way to kill an individual repair.  The only
option is to kill all repairs targeting a given node.  This is done by
running <code>riak_core_vnode_manager:kill_repairs(Reason)</code> on the node
undergoing repair.  This means you&rsquo;ll either have to be attached to
that node&rsquo;s console or you can use the <code>rpc</code> module to make a remote
call.  Here is an example of killing all repairs targeting partitions
on the local node.</p>

<pre><code class="language-erlang">riak_core_vnode_manager:kill_repairs(killed_by_user).
</code></pre>

<p>Log entries will reflect that repairs were killed manually, something akin to this:</p>

<pre><code>2012-08-10 10:14:50.529 [warning] &lt;0.154.0&gt;@riak_core_vnode_manager:handle_cast:395 Killing all repairs: killed_by_user
</code></pre>

<p>Here is an example of executing the call remotely.</p>

<pre><code class="language-erlang">rpc:call('dev1@127.0.0.1', riak_core_vnode_manager, kill_repairs, [killed_by_user]).
</code></pre>

<p>When you&rsquo;re done, press <code>Ctrl-D</code> to disconnect the console.</p>

<p>Repairs are not allowed to occur during ownership changes.  Since
ownership entails the moving of partition data it is safest to make
them mutually exclusive events.  If you join or remove a node all
repairs across the entire cluster will be killed.</p>

<h2 id="repairing-leveldb:2251b6d571e7a2a3be2d5d3e1ae405b3">Repairing LevelDB</h2>

<p>In the event of major hardware or filesystem problems, LevelDB can become corrupted. These failures are uncommon, but they could happen, as heavy loads can push I/O limits.</p>

<h3 id="checking-for-compaction-errors:2251b6d571e7a2a3be2d5d3e1ae405b3">Checking for Compaction Errors</h3>

<p>Any time there is a compaction error, it will be noted in the LevelDB logs. Those logs are located in a <code>LOG</code> file in each instance of LevelDB in a Riak node, specifically in <code>#(platform_data_dir)/leveldb/&lt;vnode&gt;/LOG</code>. The <code>platform_data_dir</code> can be specified in the <code>[[riak.conf|Configuration Files]]</code> configuration file. The default is <code>./data</code>.</p>

<p>Compaction error messages take the following form:</p>

<pre><code>&lt;timestamp&gt; Compaction Error: Corruption: corrupted compressed block contents
</code></pre>

<p>To check whether your node has experienced such errors, you will need to run a script that searches for <code>Compaction Error</code> in each <code>LOG</code> file. Here is an example script:</p>

<pre><code class="language-bash">find . -name &quot;LOG&quot; -exec grep -l 'Compaction error' {} \;
</code></pre>

<p>If there are compaction errors in any of your vnodes, those will be listed in the console. If any vnode has experienced such errors, you would see output like this:</p>

<pre><code>./442446784738847563128068650529343492278651453440/LOG 
</code></pre>

<div class="note">
<div class="title">Note</div>
While corruption on one vnode is not uncommon, corruption in several vnodes very likely means that there is a deeper problem that needs to be address, perhaps on the OS or hardware level.
</div>

<h2 id="healing-corrupted-leveldbs:2251b6d571e7a2a3be2d5d3e1ae405b3">Healing Corrupted LevelDBs</h2>

<p>{{#1.3.0-}}
<div class="note">
<div class="title">Warning</div>
There is a known issue in Riak 1.2.x where running a LevelDB repair will bring down a machine and affect the whole cluster as a result.  Please contact Basho support before running a LevelDB repair on any Riak 1.2.x nodes.
</div>
{{/1.3.0-}}</p>

<p>The first step in properly addressing this problem is to stop the node.</p>

<pre><code class="language-bash">riak stop
</code></pre>

<p>Repairing the corrupted LevelDB can be done through the <a href="http://learnyousomeerlang.com/starting-out">Erlang shell</a>. Do not start Riak at this point; use the shell only.</p>

<p>You can fire up the shell by running the <code>erl</code> command. To ensure that you start up the shell using the same version of Erlang that&rsquo;s embedded with Riak, you should run the <code>erl</code> command as an absolute path. Here&rsquo;s an example:</p>

<pre><code class="language-bash">/opt/local/riak/erts-5.8.5/bin/erl
</code></pre>

<p>Once you&rsquo;re in the shell, run the following command:</p>

<pre><code class="language-erlang">[application:set_env(eleveldb, Var, Val) || {Var, Val} &lt;- 
    [{max_open_files, 2000}, 
     {block_size, 1048576}, 
     {cache_size, 20*1024*1024*1024}, 
     {sync, false}, 
     {data_root, &quot;&quot;}]].
</code></pre>

<p>For each corrupted LevelDB that you found using the <code>find</code> command (as demonstrated above), run the following <code>repair</code> command, substituting the path to your LevelDB vnodes and the appropriate vnode number:</p>

<pre><code class="language-erlang">eleveldb:repair(&quot;/path-to-vnode/&lt;vnode_number&gt;&quot;, []).
</code></pre>

<p>This process will likely take several minutes. When it has completed successfully, you can restart the node and continue as usual.</p>

<pre><code class="language-bash">riak start
</code></pre>

<h2 id="repairing-partitions:2251b6d571e7a2a3be2d5d3e1ae405b3">Repairing Partitions</h2>

<p>If you have experienced a loss of object replicas in your cluster, you
may need to perform a repair operation on one or more of your data
[[partitions|Clusters#The-Ring]]. Repairs of Riak KV data are typically
run in situations where partitions or whole nodes are lost due to
corruption or hardware failure. In these cases, nodes or partitions are
brought back online without any data, which means that the need to
repair data will depend mainly on your use case and on whether [[active
anti-entropy]] is enabled.</p>

<p>You will need to run a repair if the following are both true:</p>

<ul>
<li>Active anti-entropy is [[disabled|Managing Active
Anti-Entropy#Disabling-Active-Anti-Entropy]]</li>
<li>You have both non-expiring data and keys that are not accessed
frequently (which means that they are not likely to be subject to
[[read repair|Active Anti-Entropy#Read-Repair-vs-Active-Anti-Entropy]])</li>
</ul>

<p>You will most likely not need to run a repair operation if <em>any</em> of the
following is true:</p>

<ul>
<li>Active anti-entropy is [[enabled|Active
Anti-Entropy#Enabling-Active-Anti-Entropy]]</li>
<li>Your entire key set is accessed frequently, allowing passive read
repair to repair the partitions</li>
<li>Your data expires frequently</li>
</ul>

<p>In most cases, we recommend either using active anti-entropy or, if
necessary and only when necessary, running a repair operation using the
instructions below.</p>

<h3 id="running-a-repair-2:2251b6d571e7a2a3be2d5d3e1ae405b3">Running a Repair</h3>

<p>The Riak KV repair operation will repair objects from a node&rsquo;s adjacent
partitions on the ring, consequently fixing the index. This is done as
efficiently as possible by generating a hash range for all the buckets
and thus avoiding a preflist calculation for each key. Only a hash of
each key is done, its range determined from a bucket-&gt;range map, and
then the hash is checked against the range.</p>

<p>Repairs are not allowed to occur during ownership changes. Since
ownership entails the moving of partition data it is safest to make them
mutually exclusive events. If you join or remove a node all repairs
across the entire cluster will be killed.</p>

<h3 id="repairing-a-single-partition:2251b6d571e7a2a3be2d5d3e1ae405b3">Repairing a Single Partition</h3>

<p>In the case of data loss in a single partition, only that partition can
be repaired.</p>

<ol>
<li><p>From any node in the cluster, attach to Riak&rsquo;s Erlang shell:</p>

<pre><code class="language-bash">riak attach
</code></pre>

<p>You may have to hit <strong>Enter</strong> again to get a console prompt.</p></li>

<li><p>Execute the repair for a single partition using the below command:</p>

<pre><code class="language-erlang">riak_kv_vnode:repair(&lt;Partition_ID&gt;).
</code></pre>

<p>where <code>&lt;Partition_ID&gt;</code> is replaced by the ID of the partition to
repair. For example:</p>

<pre><code class="language-erlang">riak_kv_vnode:repair(251195593916248939066258330623111144003363405824).
</code></pre></li>

<li><p>Once the command has been executed, detach from Riak using
<code>Control-C</code>.</p></li>
</ol>

<h3 id="repairing-all-partitions-on-a-node:2251b6d571e7a2a3be2d5d3e1ae405b3">Repairing All Partitions on a Node</h3>

<p>If a node is lost, all partitions currently owned by that node can be
repaired.</p>

<ol>
<li><p>From any node in the cluster, attach to Riak&rsquo;s Erlang shell:</p>

<pre><code class="language-bash">riak attach
</code></pre></li>

<li><p>Get a copy of the current Ring:</p>

<pre><code class="language-erlang">{ok, Ring} = riak_core_ring_manager:get_my_ring().
</code></pre>

<p>You will get a lot of output with ring record information.
You can safely ignore it.</p></li>

<li><p>Get a list of partitions owned by the node that needs to be repaired.
Replace <code>dev1@127.0.0.1</code> with the name of the node to be repaired.  The
name can be found in each node&rsquo;s <code>vm.args</code> file, specified as the
<code>-name</code> parameter, if you are using the older configuration system; if
you are using the newer, <code>riak-conf</code>-based system, the name is given by
the <code>nodename</code> parameter.</p>

<pre><code class="language-erlang">Partitions = [P || {P, 'dev1@127.0.0.1'} &lt;- riak_core_ring:all_owners(Ring)].
</code></pre>

<p><strong>Note</strong>: The above is an <a href="http://www.erlang.org/doc/programming_examples/list_comprehensions.html">Erlang list
comprehension</a>
that loops over each <code>{Partition, Node}</code> tuple in the ring and
extracts only the partitions that match the given node name, as a
list.</p></li>

<li><p>Execute the repair on all the partitions. Executing the repairs all
at once will cause a lot of <code>{shutdown, max_concurrency}</code> messages in
the logs. These can be safely ingored, as it is just the transfers
mechanism enforcing an upper limit on the number of concurrent
transfers.</p>

<pre><code class="language-erlang">[riak_kv_vnode:repair(P) || P &lt;- Partitions].
</code></pre></li>

<li><p>Once the command has been executed, detach from Riak using
<code>Control-C</code>.</p></li>
</ol>

<h3 id="monitoring-repairs:2251b6d571e7a2a3be2d5d3e1ae405b3">Monitoring Repairs</h3>

<p>The above repair commands can be monitored via the <code>riak-admin
transfers</code> command.</p>

<h3 id="killing-a-repair-2:2251b6d571e7a2a3be2d5d3e1ae405b3">Killing a Repair</h3>

<p>Currently there is no easy way to kill an individual repair. The only
option is to kill all repairs targeting a given node. This is done by
running <code>riak_core_vnode_manager:kill_repairs(Reason)</code> on the node
undergoing repair.  This command can be executed from a <code>riak attach</code>
session like below:</p>

<pre><code class="language-erlang">riak_core_vnode_manager:kill_repairs(killed_by_user).
</code></pre>

<p>Log entries will reflect that repairs were killed manually, and will
look similar to:</p>

<pre><code>2012-08-10 10:14:50.529 [warning] &lt;0.154.0&gt;@riak_core_vnode_manager:handle_cast:395 Killing all repairs: killed_by_user
</code></pre>

<p>Repairs on a node can also be killed remotely from another node in the
cluster. From a <code>riak attach</code> session the below command can be used:</p>

<pre><code class="language-erlang">rpc:call('dev1@127.0.0.1', riak_core_vnode_manager, kill_repairs, [killed_by_user]).
</code></pre>


      <div class="clear"></div>

    </article>

    <footer class="mastfooter">
    This work is licensed under a
    <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">
        Creative Commons Attribution 4.0 International Public License
    </a><br>
    &copy; 2011-2016&nbsp;<a href="http://www.basho.com">Basho Technologies, Inc.</a>
</footer>


  </div>

  <script src="/js/all.js" type="text/javascript"></script>
<script type= "text/javascript">
  
  hljs.configure({languages: []});
  hljs.initHighlighting();

  
  
  
  $(function() {
    $(".js_enabled pre").css("visibility", "visible");
  });
</script>


</body>
</html>
