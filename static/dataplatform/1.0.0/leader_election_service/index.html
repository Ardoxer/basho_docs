<!DOCTYPE html>

<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"></html><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"></html><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"></html><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->




<head class="tutorials">
  <meta charset="utf-8">
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width">
  <meta name="project" content="dataplatform">
  <meta name="version" content="1.0.0">
  <meta name="base-url" content="">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

  <title>Leader Election Service</title>

  <link href="/css/all.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/css/print.css" media="print" rel="stylesheet" type="text/css">

  
  <style type="text/css"> .js_enabled pre { visibility : hidden; } </style>
  <script type="text/javascript">
    document.documentElement.className = 'js_enabled';
  </script>
</head>



<body class="dataplatform 1.0.0 latest ">

  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-T9C8MK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-T9C8MK');</script>

  
<aside id="nav-container" role="complementary">
  <nav class="overview" id="primary-nav" role="nav">
    <div id="primary-nav-content">
      <h2 class="responsive-link"><a class="responsive-toggle"></a></h2>

      
      <form id="searchbox_011972015458788978446:zgdcy4fa-o0" action="">
        <div class="nav-field-container">
          <div id="icon-container-search">
            <div class="icon-container"><span aria-hidden="true" class="nav-icon-search icon-search"></span></div>
            <span class="separator">&#124;</span>
          </div>
          <input id="main-search" name="q" placeholder="Search" size="5" type="search" />
        </div>
      </form>

      <div class="clear"></div>

      
      <h3 class="responsive-link visit-basho">
        <a href="http://www.basho.com">
          <div class="icon-container">
            <span aria-hidden="true" class="nav-icon" data-icon="&#xe003;"></span>
          </div>
          <span class="separator">&#124;</span>
          <span class="menu-title">Visit Basho</span>
          <div class="clear"></div>
        </a>
      </h3>

      
      <h3 class="responsive-link">
        <a href="/index.html">
          <div class="icon-container">
            <span aria-hidden="true" class="nav-icon" data-icon="&#xe003;"></span>
          </div>
          <span class="separator">&#124;</span>
          <span class="menu-title">All Riak Projects</span>
          <div class="clear"></div>
        </a>
      </h3>

      
      
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon "></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/dataplatform/1.0.0/leader_election_service/">** Leader Election Service</a></span>
        <div class="clear"></div>
      </h3>
      
       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-lambda"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/dataplatform/1.0.0/downloads/">Download Basho Data Platform</a></span>
        <div class="clear"></div>
      </h3>
      
       
      <h3>
        <div class="icon-container"><span aria-hidden="true" class="nav-icon icon-comments"></span>&nbsp;</div>
        <span class="separator">&#124;</span>
        <span class="menu-title"><a href="/community">Community</a></span>
        <div class="clear"></div>
      </h3>
      <ul></ul> 
    </div>
  </nav>

  
  <ul id="fixed-nav">
    <li>
      <a href="https://github.com/basho/basho_docs" target="_blank">
        <div class="icon-container">
          <span aria-hidden="true" class="nav-icon" data-icon="&#xe004;"></span>
        </div>
        <span class="separator">&#124;</span>Available on GitHub
      </a>
    </li>
    <li>
      <a href="/riak/latest/community/">
        <div class="icon-container">
          <span aria-hidden="true" class="nav-icon" data-icon="&#xf059;"></span>
        </div>
        <span class="separator">&#124;</span>Get Help
      </a>
    </li>
  </ul>
</aside>


  <script>
  (function() {
    var cx = '011972015458788978446:zgdcy4fa-o0';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div style="width:0px;overflow:hidden;height:0px;">
  <gcse:search></gcse:search>
</div>


  <div role="main">

    <header class="masthead">
  <div id="header">
    
    <div id="header-inner">
      <div class="icon-reorder" id="nav-toggle"></div>

      <div id="top-nav">
        
        <a href="/dataplatform/1.0.0/downloads/"><span class="icon-download-alt"></span>Downloads</a>
        <div id="nav-more"><span class="icon-more"></span></div>
      </div>

      <a class="responsive-toggle"></a>
      
      
      <a class="logo" href="/index.html"><h1>Riak Docs</h1></a>
      
      <span class="tagline">Product tutorials, how-tos, and fully-documented APIs.</span>
      <div id="nav-menu">
        <h2>Links</h2>
        <ul>
          <li><a href="http://docs.basho.com/">Docs Home</a></li>
          <li><a href="http://basho.com/">Basho Website</a></li>
        </ul>
        
        <div id="nav-menu-arrow"></div>
        <div id="nav-menu-arrow-back"></div>
      </div>

      <div class="clear"></div>

      <div class="header-rule"></div>
    </div>
  </div>
</header>


    <article class="mainarticle">

      <div class="versions">
  <div id="version-ddown-button" class="unselected">
    <div class="version-ddown-title">Version</div>
    <div class="version-ddown-number">1.0.0</div>
    <div class="version-ddown-arrow"></div>
  </div>
  <ol id="version-list" style="display: none;">
  
  
    
    
    
      
      <li class="sans versions-0 current">DEV</li>
      
      <li class="current versions-0 first"><a class="versioned" href="/dataplatform/1.0.0/leader_election_service/">1.0.0</a></li>
    
  
  
  
  </ol>
</div>


      
      

      <header><h1>Leader Election Service</h1></header>

      

      

      

<blockquote>
<p>Leader Election Service is available to <a href="http://info.basho.com/Wiki_Riak_Enterprise_Request.html">Enterprise users only</a>.</p>
</blockquote>

<h2 id="overview:56fa73174cf10c782023d6b9991d3415">Overview</h2>

<p>The Basho Data Platform (BDP) Leader Election Service enables Spark clusters to
run without a ZooKeeper instance.</p>

<p>The Leader Election Service uses a simple, line-based, ascii protocol to
interact with Spark. This protocol is incompatible with the ZooKeeper protocol,
and requires a BDP-specific patch to Spark for compatibility purposes. The
Protocol Details section of this page further details the Leader Election
Service protocol.</p>

<p>The service can be run on any or all nodes in a Riak cluster, so long as those
nodes have <a href="https://github.com/basho/riak_ensemble"><code>riak_ensemble</code></a>. Because it uses a strongly
consistent backing store that is spread across the entire cluster, it does not
normally matter which nodes are running the service. As long as there are no
network partitions or outages interfering with normal operation, you should be
able to point Spark to any Riak node that is running the election service, and
everything will work the same way regardless.</p>

<p>Many groups of clients can use the election service at the same time by defining
different election group names when they connect. If a client connects to a
group that does not currently exist, it will be automatically created. That
client is then elected leader. Leaders remain elected indefinitely until they
disconnect from the service. A new leader is chosen from the remaining clients.</p>

<h2 id="setup-and-configuration:56fa73174cf10c782023d6b9991d3415">Setup and Configuration</h2>

<p>Before enabling the leader election service, strong consistency must be enabled
on your Riak cluster, as described in the Managing Strong Consistency
documentation. You can verify that strong consistency has been successfully
enabled by using the ‘riak-admin ensemble-status’ command.</p>

<p>By default, any new data platform installation will include a commented template
configuration for the leader election service in <code>riak.conf</code>. This should look
something like this:</p>

<pre><code class="language-riakconf">## listener.leader_latch.internal = 127.0.0.1:5323
</code></pre>

<p>If you uncomment this line on a given node and restart Riak, that node will
start listening for leader election clients over the loopback interface on TCP
port 5323. Changing the IP address here changes which network interface the
service listens on. This be necessary if Spark is running on a different host
from Riak.</p>

<blockquote>
<p><strong>Warning</strong></p>

<p>Please note that this service provides no authentication mechanism. Whatever
network interface you use must be shielded from external connection attempts.
Otherwise an outside attacker could potentially perform a denial of service
attack against your cluster.</p>
</blockquote>

<p>The example configuration above specifies a single interface/port pair to listen
on. The “internal” part of this configuration line is a name given to this
instance of the service.</p>

<p>You can replace “internal” with whatever name you like. You can also specify as
many listener interfaces as you choose, as long as multiple listeners on the
same node have different names.</p>

<p>For example:</p>

<pre><code class="language-riakconf">listener.leader_latch.internal = 127.0.0.1:5323
listener.leader_latch.external = 10.10.1.2:5323
listener.leader_latch.testing = 192.168.0.42:12345
</code></pre>

<p>Note that changes to these settings will not have an impact on a live running
node. You must restart the given Riak node for changes to take effect.</p>

<h2 id="operational-concerns:56fa73174cf10c782023d6b9991d3415">Operational Concerns</h2>

<p>The leader service relies on a strongly consistent backing store, shared by all
the nodes in the Riak cluster. To guarantee liveness of this backing store, a
majority of nodes in the cluster must be available and able to communicate with
one another. If a node running the election service loses contact with a
majority of other nodes (due to downed nodes, network outages, performance
problems, etc.), then the service will become unavailable until the situation is
resolved.</p>

<p>As mentioned before, this service provides no security guarantees or
authentication mechanisms of any kind. It is your responsibility to prevent
outside access to the leader election service.</p>

<h2 id="protocol-details:56fa73174cf10c782023d6b9991d3415">Protocol Details</h2>

<p>The following section details the implementation of the election service. This
may be helpful for debugging and testing the election service, or creating a new
client beyond the existing Spark connector.</p>

<h3 id="implementation:56fa73174cf10c782023d6b9991d3415">Implementation</h3>

<p>The protocol used for this service is a simple, line-based, ascii protocol. You
can test and interact with the service using telnet (or an equivalent utility).</p>

<p>There is currently only one command a client can send to the service:</p>

<pre><code class="language-telnet">JOIN »group_name« »client_name«
</code></pre>

<p>This command tells the election service to add a client named <code>»client_name«</code> to
an election group named »group_name«`.</p>

<p>Both the client name and the group name must be ascii strings with no spaces in
them. Under normal circumstances, the service should respond with:</p>

<pre><code>LEADER »current_leader«
</code></pre>

<p>The connection must remain open as long as the client wishes to remain a part of
the election group. Any subsequent leader changes will be asynchronously pushed
to the client across this same connection.</p>

<p>If the service becomes unavailable (for example, an outage involving a majority
of Riak nodes) and a client attempts to join an election group, the server may
respond with an error message reading:</p>

<pre><code>JOIN_FAILED SERVICE_UNAVAILABLE
</code></pre>

<p>If a client attempts to execute any additional joins (to the same or other group
names) on the same connection after the initial join is performed, the server
will respond with:</p>

<pre><code>ALREADY_JOINED »group_name« »client_name«
</code></pre>

<p>And the additional join attempt(s) will fail.</p>

<p>If a client attempts to send an invalid command the server will respond with
<code>ERROR</code>.</p>

<h3 id="example-session:56fa73174cf10c782023d6b9991d3415">Example Session</h3>

<p>Following is an example interaction with the election service:</p>

<pre><code class="language-bash">telnet 127.0.0.1 5323
</code></pre>

<pre><code class="language-telnet">Trying 127.0.0.1...

Connected to localhost.

Escape character is '^]'.

JOIN test_group 1

JOIN_FAILED SERVICE_UNAVAILABLE

Connection closed by foreign host.
</code></pre>

<p>In this case the cluster only had one out of three members online, because we
forgot to start the other two nodes. Because a majority of members were offline,
we were unable to join the election group. If we start up the other two nodes
and try again::</p>

<pre><code class="language-bash">telnet 127.0.0.1 5323
</code></pre>

<pre><code class="language-telnet">Trying 127.0.0.1...

Connected to localhost.

Escape character is '^]'.

JOIN test_group 1

LEADER 1
</code></pre>

<p>Great. We have one member named &ldquo;1&rdquo; in test_group, so as we expect, they are
elected leader. Now let&rsquo;s leave that session running, then open another terminal
and join another member to the group:</p>

<pre><code class="language-bash">telnet 127.0.0.1 5323
</code></pre>

<pre><code class="language-telnet">Trying 127.0.0.1...

Connected to localhost.

Escape character is '^]'.

JOIN test_group 2

LEADER 1
</code></pre>

<p>Since 1 is still up and running, they&rsquo;re still the leader. When we join 2 to the
group, it tells us that 1 is the current leader. If we close our first terminal
window, then this new session should be elected leader after a short timeout.
Let&rsquo;s try it out:</p>

<pre><code class="language-telnet">LEADER 2
</code></pre>

<p>Our new connection is notified that client 2 is the new leader.</p>


      <div class="clear"></div>

    </article>

    <footer class="mastfooter">
    This work is licensed under a
    <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">
        Creative Commons Attribution 4.0 International Public License
    </a><br>
    &copy; 2011-2016&nbsp;<a href="http://www.basho.com">Basho Technologies, Inc.</a>
</footer>


  </div>

  <script src="/js/all.js" type="text/javascript"></script>
<script type= "text/javascript">
  
  hljs.configure({languages: []});
  hljs.initHighlighting();

  
  
  
  $(function() {
    $(".js_enabled pre").css("visibility", "visible");
  });
</script>


</body>
</html>
